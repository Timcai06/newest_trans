# æ’ä»¶å‰åç«¯ä»»åŠ¡åˆ†é…åˆ†æ

> **æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2026-01-08  
> **åˆ†æèŒƒå›´**: Background Scriptã€Content Scriptã€Popup ä¸‰è€…ä¹‹é—´çš„èŒè´£åˆ’åˆ†å’Œé€šä¿¡æœºåˆ¶

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [ä¸‰å¤§ç»„ä»¶èŒè´£](#ä¸‰å¤§ç»„ä»¶èŒè´£)
3. [é€šä¿¡æµç¨‹å›¾](#é€šä¿¡æµç¨‹å›¾)
4. [æ¶ˆæ¯ç±»å‹è¯¦è§£](#æ¶ˆæ¯ç±»å‹è¯¦è§£)
5. [æ•°æ®å­˜å‚¨ç­–ç•¥](#æ•°æ®å­˜å‚¨ç­–ç•¥)
6. [å®é™…æ¡ˆä¾‹è§£æ](#å®é™…æ¡ˆä¾‹è§£æ)

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

ä½ çš„ Chrome æ‰©å±•é‡‡ç”¨ç»å…¸çš„**ä¸‰å±‚æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Popup (å¼¹çª—ç•Œé¢)                â”‚
â”‚  - UI å±•ç¤ºå’Œäº¤äº’                        â”‚
â”‚  - æ•°æ®ç®¡ç†ï¼ˆè¯»å†™ Chrome Storageï¼‰      â”‚
â”‚  - ä¸ç›´æ¥è°ƒç”¨ API                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ è¯»å–/å†™å…¥
         Chrome Storage API
              â†‘ è¯»å–/å†™å…¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Content Script (å†…å®¹è„šæœ¬)           â”‚
â”‚  - æ³¨å…¥åˆ°ç½‘é¡µä¸­è¿è¡Œ                     â”‚
â”‚  - DOM æ“ä½œå’Œé¡µé¢äº¤äº’                   â”‚
â”‚  - é«˜äº®æ˜¾ç¤ºã€å¼¹çª—æ˜¾ç¤º                   â”‚
â”‚  - è°ƒç”¨ Background è¿›è¡Œç¿»è¯‘             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ chrome.runtime.sendMessage
         Background Service
              â†‘ chrome.runtime.onMessage
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Background Script (åå°æœåŠ¡)          â”‚
â”‚  - API è°ƒç”¨ï¼ˆç¿»è¯‘æœåŠ¡ã€AI æœåŠ¡ï¼‰        â”‚
â”‚  - å¯†é’¥ç®¡ç†                             â”‚
â”‚  - è·¨æ ‡ç­¾é¡µé€šä¿¡                         â”‚
â”‚  - é¡µé¢å¯¼èˆªç›‘å¬                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä¸‰å¤§ç»„ä»¶èŒè´£

### 1ï¸âƒ£ Background Script (`core/background.js`)

**æ ¸å¿ƒèŒè´£ï¼šç½‘ç»œè¯·æ±‚å’Œè·¨æ ‡ç­¾é¡µé€šä¿¡**

#### âœ… è´Ÿè´£çš„ä»»åŠ¡ï¼š

1. **API è°ƒç”¨**
   ```javascript
   // è°ƒç”¨ç¿»è¯‘ API
   - translateWithYoudao()      // ç½‘æ˜“æœ‰é“ç¿»è¯‘
   - smartTranslate()           // æ™ºèƒ½ç¿»è¯‘ï¼ˆAI + æœ‰é“ï¼‰
   - self.aiAnalyze()           // AI åˆ†æ
   ```

2. **æ¶ˆæ¯ç›‘å¬å’Œå¤„ç†**
   ```javascript
   chrome.runtime.onMessage.addListener((msg, sender, sendResponse) => {
     // å¤„ç†çš„æ¶ˆæ¯ç±»å‹ï¼š
     - 'SMART_TRANSLATE'      // æ™ºèƒ½ç¿»è¯‘è¯·æ±‚
     - 'AI_ANALYZE'           // AI åˆ†æè¯·æ±‚
     - 'YOUDAO_TRANSLATE'     // æœ‰é“ç¿»è¯‘è¯·æ±‚ï¼ˆé—ç•™ï¼‰
     - 'RUN_TESTS'            // æµ‹è¯•å¥—ä»¶
     - 'GET_QUALITY_REPORT'   // è´¨é‡æŠ¥å‘Š
   });
   ```

3. **é¡µé¢å¯¼èˆªç›‘å¬**
   ```javascript
   // ç›‘å¬é¡µé¢åŠ è½½å®Œæˆï¼Œé€šçŸ¥ Content Script é‡æ–°é«˜äº®
   chrome.webNavigation.onCommitted.addListener()
   chrome.webNavigation.onHistoryStateUpdated.addListener()
   chrome.tabs.onUpdated.addListener()
   ```

4. **API å¯†é’¥ç®¡ç†**
   ```javascript
   // ä» Chrome Storage è·å–ç”¨æˆ·é…ç½®çš„ API å¯†é’¥
   async function getYoudaoCredentials()
   ```

#### âŒ ä¸è´Ÿè´£çš„ä»»åŠ¡ï¼š

- âŒ DOM æ“ä½œ
- âŒ é¡µé¢ UI å±•ç¤º
- âŒ ç”¨æˆ·ç•Œé¢äº¤äº’

---

### 2ï¸âƒ£ Content Script (`core/content.js`)

**æ ¸å¿ƒèŒè´£ï¼šé¡µé¢äº¤äº’å’Œ DOM æ“ä½œ**

#### âœ… è´Ÿè´£çš„ä»»åŠ¡ï¼š

1. **é¡µé¢äº¤äº’å¤„ç†**
   ```javascript
   // æ–‡æœ¬é€‰æ‹©
   - handleTextSelection()        // å¤„ç†æ–‡æœ¬é€‰æ‹©
   - executeTranslation()         // æ‰§è¡Œç¿»è¯‘
   - handleHighlightClick()       // å¤„ç†é«˜äº®å•è¯ç‚¹å‡»
   ```

2. **DOM æ“ä½œ**
   ```javascript
   // é«˜äº®æ˜¾ç¤º
   - highlightTranslatedWords()   // é«˜äº®å·²ç¿»è¯‘çš„å•è¯
   - renderPopup()                // æ¸²æŸ“ç¿»è¯‘å¼¹çª—
   - showClickTooltip()           // æ˜¾ç¤ºç‚¹å‡»æç¤ºæ¡†
   ```

3. **è°ƒç”¨ Background è¿›è¡Œç¿»è¯‘**
   ```javascript
   // é€šè¿‡ chrome.runtime.sendMessage è°ƒç”¨
   chrome.runtime.sendMessage({
     type: 'SMART_TRANSLATE',
     text: text,
     context: context,
     skipAI: skipAI
   });
   ```

4. **æœ¬åœ°ç¼“å­˜ç®¡ç†**
   ```javascript
   // ä½¿ç”¨å†…å­˜ç¼“å­˜ï¼ˆä¸æ¶‰åŠ Chrome Storageï¼‰
   - translationCache             // ç¿»è¯‘ç»“æœç¼“å­˜
   - phoneticCache                // éŸ³æ ‡ç¼“å­˜
   - exampleTranslationCache      // ä¾‹å¥ç¼“å­˜
   ```

5. **ç›‘å¬ Background æ¶ˆæ¯**
   ```javascript
   chrome.runtime.onMessage.addListener((msg) => {
     if (msg.type === 'REHIGHLIGHT') {
       // é‡æ–°é«˜äº®æ˜¾ç¤º
     }
   });
   ```

#### âŒ ä¸è´Ÿè´£çš„ä»»åŠ¡ï¼š

- âŒ ç›´æ¥è°ƒç”¨å¤–éƒ¨ APIï¼ˆæ‰€æœ‰ API è°ƒç”¨éƒ½é€šè¿‡ Backgroundï¼‰
- âŒ ç®¡ç† API å¯†é’¥
- âŒ è·¨æ ‡ç­¾é¡µé€šä¿¡

---

### 3ï¸âƒ£ Popup (`popup/popup.js`)

**æ ¸å¿ƒèŒè´£ï¼šç”¨æˆ·ç•Œé¢å’Œæ•°æ®å±•ç¤º**

#### âœ… è´Ÿè´£çš„ä»»åŠ¡ï¼š

1. **UI å±•ç¤º**
   ```javascript
   - loadHomePage()              // åŠ è½½é¦–é¡µç»Ÿè®¡
   - loadWordListPage()          // åŠ è½½å•è¯åˆ—è¡¨
   - loadSettings()              // åŠ è½½è®¾ç½®é¡µé¢
   - showPage()                  // é¡µé¢åˆ‡æ¢
   ```

2. **æ•°æ®ç®¡ç†ï¼ˆChrome Storageï¼‰**
   ```javascript
   // è¯»å–æ•°æ®
   chrome.storage.local.get(['translatedWords', 'userSettings'])
   
   // å†™å…¥æ•°æ®
   chrome.storage.local.set({ translatedWords: words })
   ```

3. **å­¦ä¹ åŠŸèƒ½**
   ```javascript
   - LearningManager              // å­¦ä¹ ç®¡ç†å™¨
   - é—ªå¡æ¨¡å¼ã€æµ‹éªŒæ¨¡å¼ã€æ‹¼å†™æ¨¡å¼
   ```

4. **æ•°æ®ç´¢å¼•å’Œæœç´¢**
   ```javascript
   - buildIndex()                // æ„å»ºæœç´¢ç´¢å¼•
   - performSearch()             // æ‰§è¡Œæœç´¢
   ```

#### âŒ ä¸è´Ÿè´£çš„ä»»åŠ¡ï¼š

- âŒ ä¸è°ƒç”¨ Background è¿›è¡Œç¿»è¯‘ï¼ˆç¿»è¯‘åœ¨ Content Script ä¸­å®Œæˆï¼‰
- âŒ ä¸æ“ä½œç½‘é¡µ DOM
- âŒ ä¸è°ƒç”¨å¤–éƒ¨ API

**å…³é”®ç‚¹**ï¼šPopup åªè´Ÿè´£å±•ç¤ºå’Œç®¡ç†**å·²å­˜å‚¨**çš„æ•°æ®ï¼Œä¸å‚ä¸å®æ—¶ç¿»è¯‘æµç¨‹ã€‚

---

### 4ï¸âƒ£ Dashboard (`popup/dashboard.html`)

**æ ¸å¿ƒèŒè´£ï¼šå­¦ä¹ æ•°æ®å¯è§†åŒ–å’Œå­¦ä¹ æ¨¡å¼ç®¡ç†**

#### âœ… è´Ÿè´£çš„ä»»åŠ¡ï¼š

1. **å­¦ä¹ æ¦‚è§ˆå±•ç¤º**
   ```javascript
   - loadLearningOverview()      // åŠ è½½å­¦ä¹ æ¦‚è§ˆæ•°æ®
   - renderStatsCards()          // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
   - createStatsCard()           // åˆ›å»ºå•ä¸ªç»Ÿè®¡å¡ç‰‡
   ```

2. **ç»Ÿè®¡å¡ç‰‡å®ç°**
   ```javascript
   - ä»Šæ—¥å­¦ä¹ å¡ç‰‡ï¼šå±•ç¤ºä»Šæ—¥å­¦ä¹ å•è¯æ•°å’Œå®Œæˆåº¦
   - æŒæ¡ç¨‹åº¦å¡ç‰‡ï¼šç¯å½¢è¿›åº¦å›¾å±•ç¤ºæŒæ¡ç¨‹åº¦
   - å¾…å¤ä¹ å¡ç‰‡ï¼šå¾…å¤ä¹ å•è¯æ•°é‡å’Œå¯è§†åŒ–æç¤º
   - è¿ç»­å­¦ä¹ å¡ç‰‡ï¼šè¿ç»­å­¦ä¹ å¤©æ•°å’Œå­¦ä¹ çƒ­åŠ›å›¾
   - æ€»å­¦ä¹ è¯æ•°å¡ç‰‡ï¼šå±•ç¤ºç´¯è®¡å­¦ä¹ å•è¯æ•°
   ```

3. **æ•°æ®å¯è§†åŒ–**
   ```javascript
   - drawCircleProgress()        // ç»˜åˆ¶ç¯å½¢è¿›åº¦å›¾
   - createStreakCalendar()      // åˆ›å»ºè¿ç»­å­¦ä¹ æ—¥å†
   - drawWordTrendChart()        // ç»˜åˆ¶å•è¯å­¦ä¹ è¶‹åŠ¿å›¾
   - æ”¯æŒå¤šç§å›¾è¡¨ç±»å‹ï¼šç¯å½¢å›¾ã€çº¿æ€§è¿›åº¦æ¡ã€çƒ­åŠ›å›¾ã€æŠ˜çº¿å›¾
   ```

4. **å­¦ä¹ è®°å½•è¯¦æƒ…**
   ```javascript
   - getLearningRecords()        // è·å–å­¦ä¹ è®°å½•
   - renderRecordList()          // æ¸²æŸ“å­¦ä¹ è®°å½•åˆ—è¡¨
   - buildIndex()                // æ„å»ºæœç´¢ç´¢å¼•
   - performSearch()             // æ‰§è¡Œæœç´¢
   - filterRecords()             // ç­›é€‰è®°å½•
   - sortRecords()               // æ’åºè®°å½•
   - paginateRecords()           // åˆ†é¡µå¤„ç†
   - exportRecords()             // å¯¼å‡ºè®°å½•
   ```

5. **å­¦ä¹ æ¨¡å¼ç®¡ç†**
   ```javascript
   - startLearningMode()         // å¼€å§‹å­¦ä¹ æ¨¡å¼
   - getLearningModes()          // è·å–æ‰€æœ‰å­¦ä¹ æ¨¡å¼
   - renderLearningModeCards()   // æ¸²æŸ“å­¦ä¹ æ¨¡å¼å¡ç‰‡
   - createModeCard()            // åˆ›å»ºå•ä¸ªå­¦ä¹ æ¨¡å¼å¡ç‰‡
   ```

6. **å­¦ä¹ ç›®æ ‡è®¾ç½®**
   ```javascript
   - setLearningGoal()           // è®¾ç½®å­¦ä¹ ç›®æ ‡
   - getLearningGoal()           // è·å–å­¦ä¹ ç›®æ ‡
   ```

7. **æ•°æ®å¯¼å‡º**
   ```javascript
   - exportLearningData()        // å¯¼å‡ºå­¦ä¹ æ•°æ®
   ```

8. **åŠ¨ç”»æ•ˆæœå®ç°**
   ```javascript
   - æ¸å…¥åŠ¨ç”»ï¼ˆfadeInï¼‰
   - ä¸Šç§»æ¸å…¥åŠ¨ç”»ï¼ˆfadeInUpï¼‰
   - ç¼©æ”¾åŠ¨ç”»ï¼ˆscaleInï¼‰
   - å¼¹è·³åŠ¨ç”»ï¼ˆbounceInï¼‰
   - è¿›åº¦æ¡å¡«å……åŠ¨ç”»ï¼ˆfillProgressï¼‰
   ```

9. **ä¸»é¢˜é€‚é…**
   ```javascript
   - æ”¯æŒæµ…è‰²/æ·±è‰²ä¸»é¢˜åˆ‡æ¢
   - ä¸»é¢˜ç›¸å…³æ ·å¼ä½¿ç”¨CSSå˜é‡
   - å›¾è¡¨é¢œè‰²æ ¹æ®ä¸»é¢˜åŠ¨æ€è°ƒæ•´
   ```

#### âŒ ä¸è´Ÿè´£çš„ä»»åŠ¡ï¼š

- âŒ ä¸è°ƒç”¨ Background è¿›è¡Œç¿»è¯‘ï¼ˆç¿»è¯‘åœ¨ Content Script ä¸­å®Œæˆï¼‰
- âŒ ä¸æ“ä½œç½‘é¡µ DOMï¼ˆé™¤äº†Dashboardé¡µé¢å†…éƒ¨ï¼‰
- âŒ ä¸è°ƒç”¨å¤–éƒ¨ API

**å…³é”®ç‚¹**ï¼šDashboard åªè´Ÿè´£å±•ç¤ºå’Œç®¡ç†**å·²å­˜å‚¨**çš„å­¦ä¹ æ•°æ®ï¼Œæä¾›æ•°æ®å¯è§†åŒ–å’Œå­¦ä¹ æ¨¡å¼é€‰æ‹©åŠŸèƒ½ã€‚

#### ğŸ”§ å®ç°ç»†èŠ‚ï¼š

**å­¦ä¹ æ¦‚è§ˆæ ¸å¿ƒå®ç°**ï¼š
```javascript
// å­¦ä¹ æ¦‚è§ˆæ•°æ®ç»“æ„
const mockStats = {
  todayLearned: 15,              // ä»Šæ—¥å­¦ä¹ å•è¯æ•°
  masteryLevel: 85,              // æŒæ¡ç¨‹åº¦ï¼ˆç™¾åˆ†æ¯”ï¼‰
  toReview: 20,                  // å¾…å¤ä¹ å•è¯æ•°
  streakDays: 7,                // è¿ç»­å­¦ä¹ å¤©æ•°
  totalWords: 500,              // æ€»å­¦ä¹ å•è¯æ•°
  dailyGoal: 20                 // æ¯æ—¥å­¦ä¹ ç›®æ ‡
};

// ç»Ÿè®¡å¡ç‰‡é…ç½®
const cards = [
  {
    title: 'ä»Šæ—¥å­¦ä¹ ',
    value: stats.todayLearned,
    icon: `<svg class="icon-svg" viewBox="0 0 24 24"></svg>`,
    subtitle: `ç›®æ ‡ ${stats.dailyGoal} è¯`,
    progress: (stats.todayLearned / stats.dailyGoal) * 100,
    color: '#3b82f6' // è“è‰²
  },
  // å…¶ä»–å¡ç‰‡é…ç½®...
];
```

**æ•°æ®å¯è§†åŒ–å®ç°**ï¼š
- ä½¿ç”¨ Canvas API ç»˜åˆ¶ç¯å½¢è¿›åº¦å›¾å’Œè¶‹åŠ¿å›¾
- ä½¿ç”¨ CSS Grid å’Œ Flexbox å®ç°å“åº”å¼å¸ƒå±€
- ä½¿ç”¨ CSS åŠ¨ç”»å®ç°å¹³æ»‘è¿‡æ¸¡æ•ˆæœ
- ä½¿ç”¨ç»å¯¹å®šä½å°† SVG å›¾æ ‡ç»Ÿä¸€æ”¾ç½®åœ¨å¡ç‰‡å³ä¸Šè§’

**åŠ¨ç”»æ•ˆæœ**ï¼š
```css
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fillProgress {
  from { width: 0%; }
  to { width: var(--progress-width); }
}
```

**å­¦ä¹ è®°å½•è¯¦æƒ…æ ¸å¿ƒå®ç°**ï¼š
```javascript
// å­¦ä¹ è®°å½•æ•°æ®ç»“æ„
const learningRecords = {
  records: [
    {
      id: 'rec_123',
      word: 'example',
      translation: 'ä¾‹å­',
      timestamp: '2026-01-11T10:30:00Z',
      mode: 'flashcard',
      correct: true,
      difficulty: 'easy',
      duration: 5000,
      type: 'word',
      starred: false
    },
    // æ›´å¤šè®°å½•...
  ],
  pagination: {
    currentPage: 1,
    totalPages: 5,
    pageSize: 20,
    totalRecords: 100
  }
};

// ç­›é€‰å’Œæ’åºé…ç½®
const filterConfig = {
  dateRange: { start: null, end: null },
  mode: 'all',
  difficulty: 'all',
  correctness: 'all',
  type: 'all',
  starred: false
};

const sortConfig = {
  field: 'timestamp',
  direction: 'desc'
};

// æœç´¢åŠŸèƒ½
async function performSearch(query) {
  // 1. æ„å»ºæœç´¢ç´¢å¼•
  await buildIndex();
  
  // 2. æ‰§è¡Œæœç´¢
  const results = wordsIndex.all.filter(word => 
    word.word.toLowerCase().includes(query.toLowerCase()) ||
    word.translation.toLowerCase().includes(query.toLowerCase())
  );
  
  // 3. æ¸²æŸ“æœç´¢ç»“æœ
  renderRecordList(results);
}
```

**è®°å½•å¡ç‰‡å®ç°**ï¼š
```javascript
function createWordCard(record) {
  const card = document.createElement('div');
  card.className = `word-card word-card--${record.type}`;
  card.innerHTML = `
    <div class="word-card__content">
      <div class="word-card__header">
        <h3 class="word-card__word">${record.word}</h3>
        <span class="word-card__type">${record.type === 'word' ? 'å•è¯' : record.type === 'phrase' ? 'çŸ­è¯­' : 'å¥å­'}</span>
      </div>
      <p class="word-card__translation">${record.translation}</p>
      <div class="word-card__meta">
        <span class="word-card__mode">${getModeLabel(record.mode)}</span>
        <span class="word-card__difficulty">${getDifficultyLabel(record.difficulty)}</span>
        <span class="word-card__correctness ${record.correct ? 'correct' : 'incorrect'}">
          ${record.correct ? 'âœ“ æ­£ç¡®' : 'âœ— é”™è¯¯'}
        </span>
        <span class="word-card__duration">${formatDuration(record.duration)}</span>
      </div>
      <div class="word-card__actions">
        <button class="star-btn ${record.starred ? 'starred' : ''}" onclick="toggleStar('${record.id}')">
          ${record.starred ? 'â˜…' : 'â˜†'}
        </button>
        <button class="delete-btn" onclick="deleteRecord('${record.id}')">
          ğŸ—‘ï¸
        </button>
      </div>
    </div>
  `;
  return card;
}
```

---

## ğŸ”„ é€šä¿¡æµç¨‹å›¾

### åœºæ™¯ 1: ç”¨æˆ·é€‰ä¸­æ–‡æœ¬è¿›è¡Œç¿»è¯‘

```
ç”¨æˆ·æ“ä½œï¼šåœ¨ç½‘é¡µä¸Šé€‰ä¸­æ–‡æœ¬
    â†“
Content Script: handleTextSelection()
    â†“
Content Script: executeTranslation()
    â†“
Content Script: translateText()
    â”œâ”€â†’ æ£€æŸ¥ç¼“å­˜ï¼ˆå†…å­˜ç¼“å­˜ï¼‰
    â”œâ”€â†’ å¦‚æœç¼“å­˜æœªå‘½ä¸­
    â”‚      â†“
    â”‚   chrome.runtime.sendMessage({
    â”‚     type: 'SMART_TRANSLATE',
    â”‚     text: text,
    â”‚     context: context
    â”‚   })
    â”‚      â†“
    â”‚   Background: chrome.runtime.onMessage
    â”‚      â†“
    â”‚   Background: smartTranslate()
    â”‚      â”œâ”€â†’ å°è¯• AI ç¿»è¯‘ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    â”‚      â””â”€â†’ å›é€€åˆ°æœ‰é“ç¿»è¯‘
    â”‚      â†“
    â”‚   Background: sendResponse({ ok: true, result })
    â”‚      â†“
    â”‚   Content Script: æ¥æ”¶ç¿»è¯‘ç»“æœ
    â”‚      â†“
Content Script: saveTranslation() â†’ chrome.storage.local.set()
    â†“
Content Script: highlightTranslatedWords()
    â†“
Content Script: showTranslationPopup()
```

### åœºæ™¯ 2: é¡µé¢åŠ è½½å®Œæˆåé‡æ–°é«˜äº®

```
é¡µé¢åŠ è½½å®Œæˆ
    â†“
Background: chrome.webNavigation.onCommitted
    â†“
Background: chrome.tabs.sendMessage(tabId, { type: 'REHIGHLIGHT' })
    â†“
Content Script: chrome.runtime.onMessage
    â†“
Content Script: chrome.storage.local.get(['translatedWords'])
    â†“
Content Script: highlightTranslatedWords()
```

### åœºæ™¯ 3: Popup å±•ç¤ºæ•°æ®

```
ç”¨æˆ·ç‚¹å‡»æ‰©å±•å›¾æ ‡
    â†“
Popup æ‰“å¼€
    â†“
Popup: chrome.storage.local.get(['translatedWords'])
    â†“
Popup: buildIndex()ï¼ˆæ„å»ºæœç´¢ç´¢å¼•ï¼‰
    â†“
Popup: loadHomePage()ï¼ˆæ˜¾ç¤ºç»Ÿè®¡æ•°æ®ï¼‰
    â†“
ç”¨æˆ·æµè§ˆå•è¯åˆ—è¡¨
```

---

## ğŸ“¨ æ¶ˆæ¯ç±»å‹è¯¦è§£

### Content Script â†’ Background

| æ¶ˆæ¯ç±»å‹ | ç”¨é€” | å‚æ•° | å“åº” |
|---------|------|------|------|
| `SMART_TRANSLATE` | æ™ºèƒ½ç¿»è¯‘è¯·æ±‚ | `{ text, context, skipAI }` | `{ ok: true, result: {...} }` |
| `AI_ANALYZE` | AI è¾…åŠ©åˆ†æ | `{ text, context }` | `{ ok: true, result: {...} }` |
| `YOUDAO_TRANSLATE` | æœ‰é“ç¿»è¯‘ï¼ˆé—ç•™ï¼‰ | `{ text }` | `{ ok: true, result: {...} }` |
| `ERROR_STAT` | é”™è¯¯ç»Ÿè®¡ä¸ŠæŠ¥ | `{ service, error }` | æ— å“åº” |
| `RUN_TESTS` | è¿è¡Œæµ‹è¯•å¥—ä»¶ | `{ iterations }` | `{ ok: true, report: {...} }` |
| `GET_QUALITY_REPORT` | è·å–è´¨é‡æŠ¥å‘Š | æ—  | `{ ok: true, report: {...} }` |

### Background â†’ Content Script

| æ¶ˆæ¯ç±»å‹ | ç”¨é€” | è§¦å‘æ—¶æœº |
|---------|------|---------|
| `REHIGHLIGHT` | é‡æ–°é«˜äº®æ˜¾ç¤º | é¡µé¢å¯¼èˆªå®Œæˆã€History API æ›´æ–° |

---

## ğŸ’¾ æ•°æ®å­˜å‚¨ç­–ç•¥

### Chrome Storage APIï¼ˆæ‰€æœ‰ç»„ä»¶å…±äº«ï¼‰

```javascript
// å­˜å‚¨çš„æ•°æ®ç±»å‹
{
  translatedWords: {        // ç¿»è¯‘è®°å½•
    "word": {
      word: "hello",
      translation: "ä½ å¥½",
      count: 5,
      type: "word",
      starred: false,
      firstUsed: "2026-01-01T00:00:00.000Z",
      lastUsed: "2026-01-08T00:00:00.000Z"
    }
  },
  userSettings: {           // ç”¨æˆ·è®¾ç½®
    backgroundTheme: "default",
    highlightTheme: "default",
    apiKey: "...",
    apiSecret: "..."
  },
  learningProgress: {       // å­¦ä¹ è¿›åº¦
    "word": {
      masteryLevel: 3,
      reviewCount: 10,
      correctCount: 8,
      nextReview: 1234567890
    }
  },
  aiSettings: {             // AI è®¾ç½®
    provider: "openai",
    apiKey: "...",
    model: "gpt-3.5-turbo"
  }
}
```

### å†…å­˜ç¼“å­˜ï¼ˆä»… Content Scriptï¼‰

```javascript
// å†…å­˜ç¼“å­˜ï¼ˆä¸æŒä¹…åŒ–ï¼‰
translationCache           // ç¿»è¯‘ç»“æœç¼“å­˜ï¼ˆ500æ¡ï¼‰
phoneticCache              // éŸ³æ ‡ç¼“å­˜ï¼ˆ200æ¡ï¼‰
exampleTranslationCache    // ä¾‹å¥ç¼“å­˜ï¼ˆ200æ¡ï¼‰
definitionTranslationCache // é‡Šä¹‰ç¼“å­˜ï¼ˆ200æ¡ï¼‰
```

**è®¾è®¡åŸå› **ï¼š
- å†…å­˜ç¼“å­˜ç”¨äº**é¢‘ç¹è®¿é—®**çš„æ•°æ®ï¼Œå‡å°‘ API è°ƒç”¨
- Chrome Storage ç”¨äº**æŒä¹…åŒ–**ç”¨æˆ·æ•°æ®ï¼Œè·¨ä¼šè¯ä¿å­˜

---

## ğŸ” å®é™…æ¡ˆä¾‹è§£æ

### æ¡ˆä¾‹ 1: å®Œæ•´çš„ç¿»è¯‘æµç¨‹

```javascript
// ===== Content Script =====
// ç”¨æˆ·é€‰ä¸­æ–‡æœ¬ "hello"
async function executeTranslation() {
  // 1. æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
  showLoadingIndicator();
  
  // 2. è°ƒç”¨ç¿»è¯‘ï¼ˆå†…éƒ¨ä¼šè°ƒç”¨ Backgroundï¼‰
  const translationResult = await translateText("hello", context, true);
  //     â†“
  //     translateText() å†…éƒ¨ï¼š
  //     â†“
  //     const response = await chrome.runtime.sendMessage({
  //       type: 'SMART_TRANSLATE',
  //       text: "hello",
  //       context: context,
  //       skipAI: true
  //     });
  
  // 3. ä¿å­˜åˆ° Chrome Storage
  await saveTranslation("hello", translationResult.translation);
  //     â†“
  //     chrome.storage.local.set({ translatedWords: {...} });
  
  // 4. é«˜äº®æ˜¾ç¤º
  await highlightTranslatedWords(words);
  
  // 5. æ˜¾ç¤ºå¼¹çª—
  await showTranslationPopup("hello", translationResult.translation, rect);
}

// ===== Background Script =====
chrome.runtime.onMessage.addListener((msg, sender, sendResponse) => {
  if (msg.type === 'SMART_TRANSLATE') {
    smartTranslate(msg.text, msg.context, msg.skipAI)
      .then(result => sendResponse({ ok: true, result }))
      .catch(err => sendResponse({ ok: false, error: err.message }));
    return true; // ä¿æŒæ¶ˆæ¯é€šé“å¼€æ”¾ï¼Œç”¨äºå¼‚æ­¥å“åº”
  }
});

async function smartTranslate(text, context, skipAI) {
  // 1. å°è¯• AI ç¿»è¯‘ï¼ˆå¦‚æœæœªè·³è¿‡ï¼‰
  if (!skipAI) {
    try {
      const aiResult = await self.translateWithAI(text, context);
      return { translation: aiResult.translation, source: 'ai' };
    } catch (aiError) {
      console.log('AI translation failed, falling back to Youdao');
    }
  }
  
  // 2. å›é€€åˆ°æœ‰é“ç¿»è¯‘
  const youdaoResult = await translateWithYoudao(text);
  return { ...youdaoResult, source: 'youdao' };
}
```

### æ¡ˆä¾‹ 2: Popup å±•ç¤ºæ•°æ®

```javascript
// ===== Popup =====
async function loadHomePage() {
  // 1. ä» Chrome Storage è¯»å–æ•°æ®
  const result = await chrome.storage.local.get(['translatedWords']);
  wordsData = result.translatedWords || {};
  
  // 2. æ„å»ºç´¢å¼•ï¼ˆç”¨äºå¿«é€Ÿæœç´¢ï¼‰
  await buildIndex();
  
  // 3. è®¡ç®—ç»Ÿè®¡æ•°æ®
  const counts = {
    word: wordsIndex.word.length,
    phrase: wordsIndex.phrase.length,
    sentence: wordsIndex.sentence.length,
    starred: wordsIndex.starred.length
  };
  
  // 4. æ›´æ–° UI
  document.getElementById('totalWords').textContent = wordsIndex.all.length;
  document.getElementById('wordCount').textContent = counts.word;
  // ...
}

// æ³¨æ„ï¼šPopup ä¸è°ƒç”¨ Backgroundï¼Œç›´æ¥ä» Storage è¯»å–æ•°æ®
```

---

## ğŸ¯ è®¾è®¡åŸåˆ™æ€»ç»“

### 1. **èŒè´£åˆ†ç¦»**

- **Background**: åªåšç½‘ç»œè¯·æ±‚å’Œè·¨æ ‡ç­¾é¡µé€šä¿¡
- **Content Script**: åªåšé¡µé¢äº¤äº’å’Œ DOM æ“ä½œ
- **Popup**: åªåš UI å±•ç¤ºå’Œæ•°æ®ç®¡ç†

### 2. **é€šä¿¡æœºåˆ¶**

- Content Script â†” Background: ä½¿ç”¨ `chrome.runtime.sendMessage`
- Background â†’ Content Script: ä½¿ç”¨ `chrome.tabs.sendMessage`
- æ‰€æœ‰ç»„ä»¶ â†” Storage: ä½¿ç”¨ `chrome.storage.local`

### 3. **æ•°æ®æµ**

```
å®æ—¶ç¿»è¯‘æ•°æ®æµ:
ç”¨æˆ·æ“ä½œ â†’ Content Script â†’ Background â†’ API â†’ Background â†’ Content Script â†’ ç”¨æˆ·ç•Œé¢

æ•°æ®æŒä¹…åŒ–æµ:
Content Script â†’ Chrome Storage â† Popupï¼ˆè¯»å–å’Œå±•ç¤ºï¼‰
```

### 4. **ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

1. **å®‰å…¨æ€§**: Background å¯ä»¥å®‰å…¨åœ°å­˜å‚¨å’Œä½¿ç”¨ API å¯†é’¥
2. **æ€§èƒ½**: Content Script å¯ä»¥ç›´æ¥æ“ä½œ DOMï¼Œæ— éœ€è·¨è¿›ç¨‹é€šä¿¡
3. **éš”ç¦»æ€§**: Popup ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¼šå½±å“ç½‘é¡µæ€§èƒ½
4. **å¯ç»´æŠ¤æ€§**: èŒè´£æ¸…æ™°ï¼Œä¾¿äºè°ƒè¯•å’Œç»´æŠ¤

---

## ğŸ“ æ€»ç»“

ä½ çš„æ’ä»¶æ¶æ„è®¾è®¡**éå¸¸åˆç†**ï¼Œéµå¾ªäº† Chrome æ‰©å±•çš„æœ€ä½³å®è·µï¼š

âœ… **Background Script** ä½œä¸º"åç«¯æœåŠ¡"ï¼Œå¤„ç†æ‰€æœ‰ç½‘ç»œè¯·æ±‚  
âœ… **Content Script** ä½œä¸º"å‰ç«¯äº¤äº’å±‚"ï¼Œå¤„ç†é¡µé¢æ“ä½œ  
âœ… **Popup** ä½œä¸º"ç®¡ç†ç•Œé¢"ï¼Œå±•ç¤ºå’Œç®¡ç†æ•°æ®  
âœ… ä¸‰è€…é€šè¿‡ **Chrome Storage** å’Œ **Message API** è¿›è¡Œé€šä¿¡

è¿™ç§è®¾è®¡ç¡®ä¿äº†ï¼š
- ğŸ”’ **å®‰å…¨æ€§**ï¼ˆAPI å¯†é’¥ä¸æš´éœ²ï¼‰
- âš¡ **æ€§èƒ½**ï¼ˆDOM æ“ä½œåœ¨é¡µé¢ä¸­ç›´æ¥æ‰§è¡Œï¼‰
- ğŸ”„ **æ•°æ®ä¸€è‡´æ€§**ï¼ˆé€šè¿‡ Storage API å…±äº«æ•°æ®ï¼‰
- ğŸ› ï¸ **å¯ç»´æŠ¤æ€§**ï¼ˆèŒè´£æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•ï¼‰

---

**å»ºè®®**: å¦‚æœéœ€è¦æ‰©å±•åŠŸèƒ½ï¼Œç»§ç»­éµå¾ªè¿™ä¸ªæ¶æ„æ¨¡å¼ï¼Œä¿æŒèŒè´£åˆ†ç¦»çš„åŸåˆ™ã€‚