# popup.js功能拆分计划

## 项目概述
本项目是一个单词翻译助手Chrome扩展，目前popup.js文件包含了所有弹窗相关的功能逻辑。为了提高代码的可维护性和可扩展性，需要将其拆分为多个功能模块。

## 拆分目标
1. 将popup.js拆分为多个独立的功能模块
2. 每个模块负责一个特定的功能领域
3. 保持popup.js只包含导入和初始化代码
4. 每一步拆分一个功能，并更新相关规范文件
5. 确保拆分后功能完整，不影响整体使用效果

## 拆分原则
1. **单一职责原则** - 每个模块只负责一个功能领域
2. **高内聚低耦合** - 模块内部紧密相关，模块之间依赖最小化
3. **命名规范** - 模块命名清晰，反映其功能
4. **易于维护** - 便于后续扩展和修改
5. **向后兼容** - 确保拆分后不破坏现有功能

## 功能模块划分

| 模块名称 | 功能描述 | 原文件行号范围 |
|---------|---------|--------------|
| 全局状态管理 | 管理应用的全局状态 | 16-37 |
| 工具函数 | 提供全局工具函数（节流、防抖等） | 43-86 |
| 学习模式管理器 | 实现学习模式功能（闪卡、测验、拼写） | 109-937 |
| 视图模式管理 | 管理不同的视图模式（网格、列表等） | 967-1004 |
| 数据管理 | 处理数据存储、索引和搜索 | 943-1278 |
| 页面管理 | 处理页面切换和显示 | 1012-1079 |
| 首页功能 | 加载和更新首页内容 | 1281-1515 |
| 学习统计 | 更新学习统计数据 | 1521-1608 |

## 拆分步骤

### 步骤1：创建拆分后的目录结构
- **目标**：创建存放拆分后模块的目录结构
- **操作**：
  1. 在popup目录下创建modules文件夹
  2. 创建计划文件：`popup/拆分计划.md`
  3. 更新项目结构文档
- **规范文件更新**：
  - 更新README.md中的项目结构
- **验证**：确保目录结构创建成功

### 步骤2：拆分全局工具函数
- **目标文件**：`popup/modules/utils.js`
- **原文件内容**：popup.js中43-86行的工具函数
- **操作**：
  1. 创建`utils.js`文件
  2. 复制工具函数到新文件
  3. 添加函数级注释
  4. 在`popup.js`中添加导入语句
  5. 删除原文件中的对应代码
- **规范文件更新**：
  - 更新项目结构文档
  - 更新样式规范文档（如有需要）
- **验证**：确保工具函数正常工作

### 步骤3：拆分学习模式管理器
- **目标文件**：`popup/modules/learning-manager.js`
- **原文件内容**：popup.js中109-937行的LearningManager类
- **操作**：
  1. 创建`learning-manager.js`文件
  2. 复制LearningManager类到新文件
  3. 添加类级和方法级注释
  4. 在`popup.js`中添加导入语句
  5. 删除原文件中的对应代码
- **规范文件更新**：
  - 更新项目结构文档
  - 更新学习模式相关规范
- **验证**：确保学习模式功能正常

### 步骤4：拆分视图模式管理
- **目标文件**：`popup/modules/view-manager.js`
- **原文件内容**：popup.js中967-1004行的视图模式管理
- **操作**：
  1. 创建`view-manager.js`文件
  2. 复制视图模式管理代码到新文件
  3. 添加函数级注释
  4. 在`popup.js`中添加导入语句
  5. 删除原文件中的对应代码
- **规范文件更新**：
  - 更新项目结构文档
  - 更新视图模式相关规范
- **验证**：确保视图切换功能正常

### 步骤5：拆分数据管理
- **目标文件**：`popup/modules/data-manager.js`
- **原文件内容**：popup.js中943-1278行的数据存储和索引
- **操作**：
  1. 创建`data-manager.js`文件
  2. 复制数据管理代码到新文件
  3. 添加函数级注释
  4. 在`popup.js`中添加导入语句
  5. 删除原文件中的对应代码
- **规范文件更新**：
  - 更新项目结构文档
  - 更新数据管理相关规范
- **验证**：确保数据加载和搜索功能正常

### 步骤6：拆分页面管理
- **目标文件**：`popup/modules/page-manager.js`
- **原文件内容**：popup.js中1012-1079行的页面切换功能
- **操作**：
  1. 创建`page-manager.js`文件
  2. 复制页面管理代码到新文件
  3. 添加函数级注释
  4. 在`popup.js`中添加导入语句
  5. 删除原文件中的对应代码
- **规范文件更新**：
  - 更新项目结构文档
  - 更新页面管理相关规范
- **验证**：确保页面切换功能正常

### 步骤7：拆分首页功能
- **目标文件**：`popup/modules/home-manager.js`
- **原文件内容**：popup.js中1281-1515行的首页加载和更新
- **操作**：
  1. 创建`home-manager.js`文件
  2. 复制首页功能代码到新文件
  3. 添加函数级注释
  4. 在`popup.js`中添加导入语句
  5. 删除原文件中的对应代码
- **规范文件更新**：
  - 更新项目结构文档
  - 更新首页功能相关规范
- **验证**：确保首页功能正常

### 步骤8：拆分学习统计
- **目标文件**：`popup/modules/learning-stats.js`
- **原文件内容**：popup.js中1521-1608行的学习统计更新
- **操作**：
  1. 创建`learning-stats.js`文件
  2. 复制学习统计代码到新文件
  3. 添加函数级注释
  4. 在`popup.js`中添加导入语句
  5. 删除原文件中的对应代码
- **规范文件更新**：
  - 更新项目结构文档
  - 更新学习统计相关规范
- **验证**：确保学习统计功能正常

### 步骤9：更新popup.js主文件
- **目标**：将popup.js简化为只包含导入和初始化代码
- **操作**：
  1. 保留必要的全局状态变量
  2. 添加所有模块的导入语句
  3. 添加初始化函数
  4. 调用初始化函数
- **规范文件更新**：
  - 更新项目结构文档
  - 更新popup.js相关规范
- **验证**：确保所有功能正常工作

## 规范文件更新

在每一步拆分后，需要更新以下规范文件：

1. **README.md** - 更新项目结构部分
2. **样式规范文档.md** - 更新相关功能模块的样式规范（如有需要）
3. **拆分计划.md** - 更新拆分进度和状态

## 验证方法

每一步拆分后，需要进行以下验证：

1. **功能验证** - 确保拆分后的功能正常工作
2. **代码检查** - 检查是否有语法错误或逻辑错误
3. **性能验证** - 确保拆分后性能不下降
4. **兼容性验证** - 确保与其他模块兼容

## 预期成果

拆分完成后，项目结构将更加清晰，代码可维护性和可扩展性将得到提升。每个功能模块将独立存在，便于后续扩展和修改。

## 拆分进度记录

| 步骤 | 模块名称 | 状态 | 完成日期 | 备注 |
|-----|---------|------|----------|------|
| 1 | 创建目录结构 | 已完成 | 2026-01-10 | 创建了modules目录 |
| 2 | 全局工具函数 | 已完成 | 2026-01-10 | 将工具函数拆分到utils-manager.js，包含AI_CONFIGS配置和节流、防抖等工具函数 |
| 3 | 学习模式管理器 | 已完成 | 2026-01-10 | 将LearningManager类拆分到learning-manager.js，使用传统脚本方式引入 |
| 4 | 视图模式管理 | 已完成 | 2026-01-10 | 将视图模式管理代码拆分到view-manager.js，包含currentViewMode变量、initViewControls和updateViewMode函数 |
| 5 | 数据管理 | 已完成 | 2026-01-10 | 将数据管理代码拆分到data-manager.js，包含数据存储、索引构建和搜索功能 |
| 6 | 页面管理 | 已完成 | 2026-01-10 | 将页面管理代码拆分到page-manager.js，包含currentPage变量和showPage函数 |
| 7 | 首页功能 | 已完成 | 2026-01-10 | 将首页功能代码拆分到home-manager.js，包含loadHomePage、updateLearningPanel、getRecentWords和showWordDetail函数 |
| 8 | 学习统计 | 已完成 | 2026-01-10 | 将学习统计功能拆分到learning-stats.js，包含updateLearningStats函数 |
| 9 | 更新popup.js主文件 | 已完成 | 2026-01-10 | 简化popup.js，只包含全局状态和LearningManager实例，新增utils-manager.js、word-list-manager.js、settings-manager.js和init-manager.js模块 |

## 版本控制

- **初始版本**：v1.0.0
- **计划完成版本**：v1.1.0

## 风险评估

1. **功能丢失风险**：拆分过程中可能丢失某些功能
   - 缓解措施：每一步都进行功能验证
2. **依赖关系风险**：模块之间的依赖关系可能处理不当
   - 缓解措施：仔细分析模块之间的依赖关系，确保正确导入
3. **性能影响风险**：拆分后可能影响性能
   - 缓解措施：进行性能验证，确保拆分后性能不下降

## 结论

通过本次拆分，将显著提高代码的可维护性和可扩展性，便于后续功能扩展和修改。每一步拆分都将严格按照计划执行，并进行充分的验证，确保拆分过程安全可靠。